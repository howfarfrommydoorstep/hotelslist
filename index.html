<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Hotel List</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --blue:#388DCD;
    --text:#000;
    --muted:#555;
    --bg:#fff;
    --zebra:#f5f5f5;
    --border:#ccc;
    --focus:#0b6fb8;
    --gap:1.4rem;
    --pad:clamp(.75rem,3vw,2.5rem);
    --radius:6px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Roboto,system-ui,-apple-system,Segoe UI,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
    font-size:.875rem;
    line-height:1.5;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:var(--gap);
  }

  h1{
    margin:0;
    text-align:center;
    color:#000;
    font-size:clamp(1.8rem,4vw,2.6rem);
    font-weight:700;
  }
  p.lead{
    margin:0;
    text-align:center;
    color:var(--muted);
    font-size:clamp(.95rem,2.6vw,1.15rem);
  }

  .controls{
    display:flex;
    align-items:center;
    gap:.75rem;
    width:100%;
    padding-inline:var(--pad);
    max-width:1200px;
    flex-wrap:wrap;
  }
  .controls .count{
    color:var(--muted);
  }
  .controls .spacer{flex:1 1 auto}
  .search{
    display:flex;
    align-items:center;
    gap:.5rem;
    margin-left:auto;
  }
  .search input{
    font:inherit;
    padding:.5rem .65rem;
    border:1px solid var(--border);
    border-radius:var(--radius);
    min-width:220px;
  }
  .search input:focus{
    outline:2px solid var(--focus);
    outline-offset:2px;
    border-color:var(--focus);
  }

  .table-wrap{
    width:100%;
    padding-inline:var(--pad);
    max-width:1200px;
    overflow:auto;
  }

  table{
    width:100%;
    border-collapse:collapse;
    font-size:.875rem;
    min-width:640px;
  }
  caption{
    text-align:left;
    padding:.25rem 0 .5rem;
    color:var(--muted);
    font-weight:400;
  }
  thead th, td{
    border:1px solid var(--border);
    padding:.5em .8em;
    vertical-align:top;
  }
  thead th{
    position:sticky;
    top:0;
    background:var(--blue);
    color:#fff;
    z-index:1;
  }

  /* Sortable header buttons */
  thead th button{
    all:unset;
    display:inline-flex;
    align-items:center;
    gap:.4em;
    cursor:pointer;
    padding:.35rem .4rem;
    border-radius:.35rem;
  }
  thead th button:focus-visible{
    outline:2px solid #fff;
    outline-offset:2px;
  }
  thead th[data-active="true"] button{
    background:rgba(255,255,255,.12);
  }

  /* Sort arrows */
  .arrow{
    width:0;
    height:0;
    border-left:4px solid transparent;
    border-right:4px solid transparent;
    border-top:6px solid #fff; /* triangle */
    transform:rotate(180deg); /* down */
    transition:transform .15s ease, opacity .15s ease;
  }
  thead th[data-dir="asc"] .arrow{ transform:rotate(0deg); }   /* up */
  thead th[data-dir="desc"] .arrow{ transform:rotate(180deg); }/* down */
  thead th[data-active="false"] .arrow{ opacity:.35; }

  tbody tr:nth-child(odd) td{ background:var(--zebra); }
  tbody tr:hover td{ background:#eaf3fb; }

  /* Column sizing */
  th[data-col="Name"], td[data-col="Name"]{ width:22%; }
  th[data-col="Area"], td[data-col="Area"]{ width:16%; white-space:nowrap; }
  th[data-col="Address"], td[data-col="Address"]{ width:62%; }

  /* Utility: visually hidden for screen readers */
  .sr-only{
    position:absolute !important;
    width:1px; height:1px;
    padding:0; margin:-1px;
    overflow:hidden; clip:rect(0,0,0,0);
    white-space:nowrap; border:0;
  }

  /* Loading skeleton */
  .skeleton{
    position:relative;
    overflow:hidden;
    background:linear-gradient(90deg,#eee 25%,#f6f6f6 37%,#eee 63%);
    background-size:400% 100%;
    animation:sheen 1.1s linear infinite;
    color:transparent;
  }
  @keyframes sheen{
    0%{background-position:100% 0}
    100%{background-position:0 0}
  }

  /* Buttons (Retry) */
  .btn{
    font:inherit;
    padding:.45rem .7rem;
    border-radius:.35rem;
    border:1px solid var(--border);
    background:#fff;
    cursor:pointer;
  }
  .btn:focus-visible{
    outline:2px solid var(--focus);
    outline-offset:2px;
  }
</style>
</head>

<body>

<h1>Hotels List</h1>
<p class="lead">Below is every Hotel / HMO identified on the map. Click a column to sort.</p>

<div class="controls" aria-live="polite">
  <div class="count" id="count">Loading…</div>
  <div class="spacer" aria-hidden="true"></div>
  <label class="search" for="q">
    <span class="sr-only">Filter hotels</span>
    <input id="q" type="search" placeholder="Filter by name, area, address" autocomplete="off" />
  </label>
</div>

<div class="table-wrap">
  <table id="t" aria-describedby="count">
    <caption class="sr-only">Sortable list of hotels with columns for Hotel name, Area, and Full Address.</caption>
    <thead>
      <tr>
        <th data-col="Name" scope="col" aria-sort="none" data-active="false" data-dir="desc">
          <button type="button" aria-label="Sort by Hotel">
            Hotel <span class="arrow" aria-hidden="true"></span>
            <span class="sr-only" data-sortstate>not sorted</span>
          </button>
        </th>
        <th data-col="Area" scope="col" aria-sort="none" data-active="false" data-dir="desc">
          <button type="button" aria-label="Sort by Area">
            Area <span class="arrow" aria-hidden="true"></span>
            <span class="sr-only" data-sortstate>not sorted</span>
          </button>
        </th>
        <th data-col="Address" scope="col" aria-sort="ascending" data-active="true" data-dir="asc">
          <button type="button" aria-label="Sort by Full Address">
            Full Address <span class="arrow" aria-hidden="true"></span>
            <span class="sr-only" data-sortstate>sorted ascending</span>
          </button>
        </th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td colspan="3" class="skeleton">Loading…</td>
      </tr>
    </tbody>
  </table>
</div>

<div class="sr-only" aria-live="polite" aria-atomic="true" id="live"></div>
<noscript>
  <p style="padding-inline:var(--pad);max-width:1200px">JavaScript is required to load and sort the hotels list.</p>
</noscript>

<script>
(() => {
  const table = document.getElementById('t');
  const thead = table.tHead;
  const tbody = table.querySelector('tbody');
  const countEl = document.getElementById('count');
  const live = document.getElementById('live');
  const q = document.getElementById('q');

  // Column configuration
  const columns = [    { key:'Name', label:'Hotel', accessor:h => h.Name ?? '' },
    { key:'Area', label:'Area', accessor:h => (h.Area ?? '').trim() },
    { key:'Address', label:'Full Address', accessor:h => h.Address ?? '' }
  ];

  // State
  const state = {
    data: [],
    filtered: [],
    sortKey: 'Address', // default active as set in thead
    sortDir: 'asc',     // default active as set in thead
    filter: ''
  };

  // Initialize from URL/localStorage
  const params = new URLSearchParams(window.location.search);
  const ls = window.localStorage;

  const savedSortKey = params.get('sort') ?? ls.getItem('hotels.sortKey');
  const savedSortDir = params.get('dir') ?? ls.getItem('hotels.sortDir');
  const savedFilter  = params.get('q') ?? ls.getItem('hotels.filter');

  if (savedSortKey) state.sortKey = savedSortKey;
  if (savedSortDir === 'asc' || savedSortDir === 'desc') state.sortDir = savedSortDir;
  if (savedFilter) { state.filter = savedFilter; q.value = savedFilter; }

  // Intl.Collator for locale-aware sorting
  const collator = new Intl.Collator(document.documentElement.lang || undefined, {
    sensitivity:'base',
    numeric:true,
    ignorePunctuation:true
  });

  // Fetch and bootstrap
  load();

  async function load(){
    setLoading(true);
    try{
      const r = await fetch(
  'https://raw.githubusercontent.com/howfarfrommydoorstep/clive/main/hotels_geocoded.json'
);
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const raw = await r.json();
      const mapped = Array.isArray(raw) ? raw.map(sanitize) : [];
      state.data = mapped;
      applyFilterAndSort();
      setLoading(false);
    }catch(err){
      console.error('Failed to load data', err);
      setLoading(false);
      renderError();
    }
  }

  function sanitize(h){
    return {
      Name: typeof h.Name === 'string' ? h.Name : '',
      Area: typeof h.Area === 'string' ? h.Area.trim() : '',
      Address: typeof h.Address === 'string' ? h.Address : ''
    };
  }

  function applyFilterAndSort(){
    // Filter
    const f = state.filter.trim().toLowerCase();
    state.filtered = !f ? [...state.data] : state.data.filter(h => {
      return (h.Name ?? '').toLowerCase().includes(f)
          || (h.Area ?? '').toLowerCase().includes(f)
          || (h.Address ?? '').toLowerCase().includes(f);
    });

    // Sort with stable secondary keys
    const primary = getAccessor(state.sortKey);
    const secondary = (a,b) => collate(a.Name, b.Name) || collate(a.Address, b.Address);
    const dir = state.sortDir === 'asc' ? 1 : -1;

    state.filtered.sort((a,b)=>{
      const ax = primary(a), bx = primary(b);
      const aBlank = ax === '' || ax == null;
      const bBlank = bx === '' || bx == null;

      // Always push blanks to bottom regardless of dir
      if (aBlank && !bBlank) return 1;
      if (!aBlank && bBlank) return -1;

      const cmp = collate(ax, bx);
      if (cmp !== 0) return cmp * dir;
      return secondary(a,b) * dir;
    });

    render();
    updateCount();
    updateURLAndStorage();
    announceSort();
  }

  function collate(a,b){
    return collator.compare(String(a ?? ''), String(b ?? ''));
  }

  function getAccessor(key){
    const col = columns.find(c => c.key === key);
    return col ? col.accessor : (h => h[key] ?? '');
  }

  function setLoading(isLoading){
    if(isLoading){
      tbody.innerHTML = '';
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 3;
      td.className = 'skeleton';
      td.textContent = 'Loading…';
      tr.appendChild(td);
      tbody.appendChild(tr);
      countEl.textContent = 'Loading…';
    }
  }

  function renderError(){
    tbody.innerHTML = '';
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 3;
    td.innerHTML = '<div style="display:flex;align-items:center;gap:.6rem;justify-content:center;padding:.6rem 0;">Failed to load data <button class="btn" type="button" id="retry">Retry</button></div>';
    tr.appendChild(td);
    tbody.appendChild(tr);
    countEl.textContent = 'Failed to load';
    live.textContent = 'Failed to load data. Use Retry to try again.';
    document.getElementById('retry').addEventListener('click', load, { once:true });
  }

  function render(){
    tbody.innerHTML = '';
    if(state.filtered.length === 0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 3;
      td.style.textAlign = 'center';
      td.style.padding = '.8rem';
      td.textContent = state.filter ? 'No results match your filter.' : 'No data available.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    const frag = document.createDocumentFragment();
    for(const h of state.filtered){
      const tr = document.createElement('tr');

      const tdN = document.createElement('td');
      tdN.dataset.col = 'Name';
      tdN.textContent = h.Name || '—';
      tr.appendChild(tdN);

      const tdA = document.createElement('td');
      tdA.dataset.col = 'Area';
      tdA.textContent = h.Area || '—';
      tr.appendChild(tdA);

      const tdD = document.createElement('td');
      tdD.dataset.col = 'Address';
      tdD.title = h.Address || '';
      tdD.textContent = h.Address || '—';
      tr.appendChild(tdD);

      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
  }

  function updateCount(){
    const total = state.data.length;
    const shown = state.filtered.length;
    const parts = [];
    parts.push(`${shown.toLocaleString()} ${shown === 1 ? 'hotel' : 'hotels'}`);
    if (state.filter && shown !== total) parts.push(`of ${total.toLocaleString()}`);
    countEl.textContent = parts.join(' ');
  }

  function updateURLAndStorage(){
    const usp = new URLSearchParams(window.location.search);
    usp.set('sort', state.sortKey);
    usp.set('dir', state.sortDir);
    if (state.filter) usp.set('q', state.filter); else usp.delete('q');
    const newUrl = `${location.pathname}?${usp.toString()}${location.hash}`;
    history.replaceState(null, '', newUrl);

    try{
      localStorage.setItem('hotels.sortKey', state.sortKey);
      localStorage.setItem('hotels.sortDir', state.sortDir);
      localStorage.setItem('hotels.filter', state.filter);
    }catch{}
  }

  function announceSort(){
    const dirWord = state.sortDir === 'asc' ? 'ascending' : 'descending';
    live.textContent = `Sorted by ${state.sortKey} ${dirWord}. ${state.filtered.length} rows.`;
  }

  // Header behavior
  initHeaders();

  function initHeaders(){
    const ths = thead.querySelectorAll('th');
    ths.forEach(th => {
      const colKey = th.getAttribute('data-col');
      const btn = th.querySelector('button');
      btn.addEventListener('click', () => onHeaderClick(colKey));
      btn.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          onHeaderClick(colKey);
        }
      });
    });

    // Set initial header states from state
    setActiveHeader(state.sortKey, state.sortDir);
  }

  function onHeaderClick(colKey){
    if (state.sortKey === colKey){
      // toggle direction
      state.sortDir = (state.sortDir === 'asc') ? 'desc' : 'asc';
    } else {
      state.sortKey = colKey;
      state.sortDir = 'asc';
    }
    setActiveHeader(state.sortKey, state.sortDir);
    applyFilterAndSort();
  }

  function setActiveHeader(key, dir){
    const ths = thead.querySelectorAll('th');
    ths.forEach(th => {
      const isActive = th.getAttribute('data-col') === key;
      th.setAttribute('data-active', isActive ? 'true' : 'false');
      th.setAttribute('data-dir', isActive ? dir : 'desc');
      th.setAttribute('aria-sort', isActive ? (dir === 'asc' ? 'ascending' : 'descending') : 'none');
      const sr = th.querySelector('[data-sortstate]');
      if (sr) sr.textContent = isActive ? `sorted ${dir === 'asc' ? 'ascending' : 'descending'}` : 'not sorted';
    });
  }

  // Filtering
  q.addEventListener('input', () => {
    state.filter = q.value;
    applyFilterAndSort();
  });
})();
</script>

</body>
</html>
